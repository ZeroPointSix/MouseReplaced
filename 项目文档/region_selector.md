# region_selector 模块介绍

## 概述

`region_selector.py` 模块提供了一个基于 `tkinter` 的图形用户界面，用于实现屏幕区域选择功能。它允许用户通过键盘交互式地选择屏幕上的特定区域，并将所选区域的中心坐标输出到指定文件。该模块主要用于需要精确屏幕坐标输入的场景，例如自动化脚本或辅助工具。

## 核心组件

### `log_to_file` 函数

- **功能**：一个辅助函数，用于将日志消息写入到与可执行文件同目录的 `region_selector_runtime.log` 文件中。这对于调试和跟踪模块的运行时行为非常有用。

### `RegionSelector` 类

- **功能**：这是区域选择器应用程序的主类，继承自 `tkinter.Tk`。它负责创建和管理全屏覆盖窗口、处理用户输入以及绘制网格。

- **属性**：
    - `layout_data`：一个二维列表，定义了屏幕网格的布局，每个元素代表一个可选择的区域。
    - `coords_file_path`：字符串，指定了最终选择的坐标将写入的文件路径。
    - `screen_width`, `screen_height`：屏幕的宽度和高度。
    - `current_level`：整数，表示当前的区域选择级别（1表示宏区域选择，2表示微区域选择）。
    - `macro_bounds`：元组，存储用户在第一级选择的宏区域的边界。
    - `grid_rects`：字典，存储每个网格键（如'Q', 'W'等）对应的屏幕坐标。
    - `valid_keys`：集合，包含所有有效的键盘按键，用于区域选择。
    - `canvas`：`tkinter.Canvas` 对象，用于在屏幕上绘制网格和文本。

- **主要方法**：
    - `__init__(self, layout_data: List[List[str]], coords_file_path: str)`：初始化 `RegionSelector` 实例，设置基本配置和UI元素。
    - `_setup_overlay_window(self)`：配置全屏透明覆盖窗口，包括设置窗口属性、创建画布和绑定事件。
    - `start(self)`：启动区域选择过程，显示窗口并绘制第一级网格。
    - `_on_key_press(self, event)`：处理键盘按键事件。根据当前选择级别，确定宏区域或微区域，并计算中心坐标写入文件。
    - `_draw_grid(self, bounds, layout)`：根据给定的边界和布局数据，在画布上绘制网格和对应的按键文本。
    - `stop(self)`：停止区域选择器并销毁窗口。

## 技术实现细节

- **全屏覆盖与透明度**：模块通过 `self.overrideredirect(True)` 移除窗口边框，并使用 `self.wm_attributes("-alpha", 0.75)` 和 `self.wm_attributes("-transparentcolor", 'black')` 实现半透明的全屏覆盖，使得用户可以清晰地看到下方的桌面内容。

- **两级区域选择**：
    - **第一级（宏区域）**：用户首先选择一个大的宏区域。此时，屏幕被划分为由 `layout_data` 定义的网格，每个网格对应一个按键。用户按下对应按键后，该宏区域被选中。
    - **第二级（微区域）**：在宏区域被选中后，该宏区域内部再次被划分为相同的网格。用户再次按下按键，选择宏区域内的微区域。最终，微区域的中心坐标被计算并写入文件。

- **键盘交互**：模块通过 `self.bind('<Key>', self._on_key_press)` 监听所有键盘按键事件，实现纯键盘操作的区域选择。同时，`Escape` 键和鼠标左键点击可以随时退出选择器。

- **坐标输出**：选定的微区域的中心坐标（X, Y）会被格式化为字符串 `X,Y` 并写入到 `coords_file_path` 指定的文件中。这使得其他程序可以方便地读取这些坐标。

- **错误处理与日志**：模块包含了基本的错误处理机制，特别是在主执行块中使用了 `try-except` 结构来捕获潜在的异常，并通过 `log_to_file` 函数记录错误信息，提高了程序的健壮性。同时，对命令行参数的检查也确保了必要的输入（布局文件和坐标文件路径）被提供。

- **Nuitka 兼容性**：从代码结构和日志记录方式来看，该模块考虑了通过 `Nuitka` 等工具打包成独立可执行文件后的运行环境，例如 `log_to_file` 函数中 `sys.argv[0]` 的使用，确保在打包后也能正确找到日志文件路径。