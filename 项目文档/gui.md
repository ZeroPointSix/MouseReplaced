# gui 模块介绍

## 概述
`gui.py` 模块是 KeyMouse 应用程序的用户图形界面 (GUI) 部分，基于 `tkinter` 库构建。它提供了直观的界面，允许用户配置键位绑定、鼠标移动速度、平滑滚动参数以及管理开机自启动等设置。该模块是用户与应用程序进行交互的主要入口。

## 核心组件

### 1. `FormattedLabel` 类
- **功能**：一个自定义的 `ttk.Label` 控件，用于格式化并显示数值，支持指定精度。
- **用途**：在界面中显示如鼠标速度、加速度等数值时，确保其显示格式统一且可控。

### 2. `ScrollableFrame` 类
- **功能**：一个可滚动的 `ttk.Frame` 控件，解决了 `tkinter` 默认 `Frame` 不支持滚动的问题。
- **用途**：当界面内容超出可见区域时，提供滚动条以便用户浏览所有设置项，尤其适用于键位设置和通用设置等内容较多的区域。
- **技术实现**：通过内嵌 `tk.Canvas` 和 `ttk.Scrollbar` 实现滚动功能，并绑定鼠标滚轮事件以提供更流畅的用户体验。

### 3. `KeyMouseGUI` 类
- **功能**：应用程序的主界面类，负责构建、管理和交互所有 GUI 元素。
- **初始化 (`__init__`)**：
  - 设置窗口标题、大小、最小尺寸和可调整性。
  - 加载 `config.ini` 配置文件，并初始化 `AppConfig`。
  - 创建主笔记本控件 (`ttk.Notebook`)，包含“键位设置”和“通用设置”两个选项卡。
  - 初始化用于键位录制的内部状态变量。
- **方法**：
  - `_create_widgets()`：调用 `create_keybindings_ui()` 和 `create_settings_ui()` 来构建所有界面元素，并创建底部的保存/恢复按钮和状态栏。
  - `get_factory_defaults()`：返回应用程序的出厂默认键位和设置值，用于恢复默认功能。
  - `create_keybindings_ui()`：构建“键位设置”选项卡的用户界面，包括鼠标移动、点击和模式控制等分组，并为每个键位创建设置行。
  - `create_key_setting(parent, label_text, config_key, row)`：辅助方法，用于创建单个键位设置行，包含标签、输入框和“设置”按钮，并绑定键位录制功能。
  - `create_settings_ui()`：构建“通用设置”选项卡的用户界面，包括系统集成（开机自启动、管理员启动）、鼠标速度、平滑滚动和性能设置等。
  - `toggle_autostart()`：处理开机自启动复选框的逻辑，调用 `autostart_manager` 模块来启用或禁用自启动，并处理可能发生的权限错误。
  - `record_key(config_key, entry)`：启动键位录制过程，将目标输入框设置为只读，并提示用户按下按键。
  - `cancel_recording(event=None)`：取消当前的键位录制，恢复输入框状态和原始值。
  - `on_key_press(event)`：处理按键事件，将用户按下的键转换为配置字符串，并更新对应的键位设置。
  - `save_settings()`：将当前界面上的所有设置保存到 `config.ini` 文件中。它会验证键位的有效性，然后将键位绑定、通用设置和平滑滚动设置写入配置文件。保存成功后，会询问用户是否立即应用新设置（通过重启程序实现）。
  - `save_current_as_default()`：将当前设置保存为默认配置，本质上是调用 `save_settings()`。
  - `apply_settings()`：重启应用程序以应用新的设置。它会根据程序是打包状态还是开发状态，构建不同的重启命令，并通过 `subprocess.Popen` 启动新进程，然后关闭当前进程。
  - `refresh_config()`：从配置文件重新加载所有设置，并更新界面上对应的控件值，用于在外部修改配置文件后同步界面显示。
  - `reset_defaults()`：将所有设置恢复到出厂默认值，但不会立即保存到文件，需要用户点击“保存设置”才能生效。

### 4. `run_gui(on_close_callback=None, tray_icon=None)` 函数
- **功能**：程序的入口函数，用于初始化 `tkinter` 根窗口，创建 `KeyMouseGUI` 实例，并启动 `tkinter` 事件循环。
- **用途**：作为从 `main.py` 或其他模块启动 GUI 的接口。
- **技术实现**：设置窗口关闭时的回调函数，确保程序在关闭时能正确执行清理操作（如托盘图标的退出）。

## 技术实现细节
- **配置文件管理**：模块通过 `configparser` 读取和写入 `config.ini` 文件，实现设置的持久化。同时，利用 `config_loader.AppConfig` 来加载和管理配置数据。
- **动态界面更新**：使用 `tk.StringVar`、`tk.IntVar` 和 `tk.DoubleVar` 等 `tkinter` 变量类型，并结合 `trace_add` 方法，实现了界面控件与后端数据之间的双向绑定，确保用户操作能实时反映在数据上，反之亦然。
- **键位录制**：通过监听 `tkinter` 的 `<Key>` 事件来捕获用户按键，并将其转换为可配置的字符串格式，方便用户自定义快捷键。
- **开机自启动**：集成了 `autostart_manager` 模块，允许用户通过 GUI 启用或禁用程序的开机自启动功能，简化了系统集成。
- **程序重启**：实现了在应用新设置后自动重启程序的功能，确保配置更改能立即生效。这考虑了程序在开发环境和打包环境下的不同启动方式。
- **错误处理**：在保存设置、切换自启动和重启程序等关键操作中，使用了 `try-except` 块来捕获异常，并通过 `messagebox` 向用户显示友好的错误提示，提升了用户体验和程序的健壮性。